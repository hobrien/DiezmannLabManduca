---
title: "RNAseq Results"
author: "Heath O'Brien"
output:
  tufte::tufte_handout: default
  #tufte::tufte_html: default
---

```{r setup, include=FALSE}
library(tidyverse)
library(devtools)
library(stringr)
library(tufte)
LibraryInfo=read_delim("../conditions.txt", "\t")

plotExpression <- function(row, LibraryInfo, title){
    dplyr::slice(row, 1) %>%
    select(one_of(paste('norm', LibraryInfo$SampleID, sep='.'))) %>%
    gather("SampleID", "Count") %>%
    mutate(SampleID = str_extract(SampleID, '[^.]+$')) %>%
    full_join(LibraryInfo) %>%
    mutate(condition=factor(condition, levels= c('Uninfected', 'WT', 'hog1'))) %>%
    ggplot(aes(y=Count, x=condition, colour=condition)) +
    geom_jitter(height = 0, width=.1) +
    ggtitle(title)
}


```

## The vast majority of reads map to Manduca contigs
```{r coverage, echo=FALSE, message=FALSE, warning=FALSE}
folder="../Mappings"
cov <- data.frame()
for (file in dir(folder, '*cov.txt')) {
  cov <- read_delim(paste(folder, file, sep='/'), "\t", escape_double = FALSE, col_names = FALSE, trim_ws = TRUE) %>%
    mutate(sample=head(strsplit(file, '\\.')[[1]], 1)) %>%
    rbind(cov)
}

cov <- mutate(cov, Organism=ifelse(str_detect(X1, '^gi'), 'Manduca', 'Candia'))

for (file in dir(folder, '*stats.txt')) {
  temp <- read_csv(paste(folder, file, sep='/'))
  colnames(temp)=c("x1")
  cov <-filter(temp, str_detect(x1, "Unmapped reads")) %>% separate(x1, into=c("Organism", "X2", "X3")) %>% 
    mutate(X1=NA, X4=NA, sample=head(strsplit(file, '\\.')[[1]], 1)) %>%
    rbind(cov) %>%
    mutate(X2=as.integer(X2), X3=as.integer(X3), X4=as.integer(X4))
}

group_by(cov, Organism, sample) %>% 
  summarise(total_reads=sum(as.integer(X3))) %>% 
  ggplot(aes(x=sample, y=total_reads)) +
    geom_bar(stat='identity') +
    facet_grid(Organism~.) 

group_by(cov, Organism, sample) %>% 
  summarise(total_reads=sum(as.integer(X3))) %>% 
  ggplot(aes(x=sample, y=total_reads)) +
    geom_bar(stat='identity') +
    facet_grid(Organism~.) +
    scale_y_log10()

```

## Summary of all DE genes (FDR<0.1)
```{r all_DE, echo=FALSE, message=FALSE}
DE <- mutate(read_delim("../Results/tables/Uninfectedvshog1.down.txt", "\t"), Comparison="Uninfectedvshog1", bias='hog1' ) %>%
  bind_rows(mutate(read_delim("../Results/tables/Uninfectedvshog1.up.txt", "\t"), Comparison="Uninfectedvshog1", bias='Uninfected' )) %>%
  bind_rows(mutate(read_delim("../Results/tables/WTvshog1.down.txt", "\t"), Comparison="WTvshog1", bias='hog1' )) %>%
  bind_rows(mutate(read_delim("../Results/tables/WTvshog1.up.txt", "\t"), Comparison="WTvshog1", bias='WT' )) %>%
  bind_rows(mutate(read_delim("../Results/tables/WTvsUninfected.down.txt", "\t"), Comparison="WTvsUninfected", bias='Uninfected' )) %>%
  bind_rows(mutate(read_delim("../Results/tables/WTvsUninfected.up.txt", "\t"), Comparison="WTvsUninfected", bias='WT' ))

knitr::kable(
  group_by(DE, Comparison, bias) %>% summarise(n=n())
)
group_by(DE, Id, bias) %>% 
  summarise(n=n()) %>% 
  filter(n>1) %>% 
  select(Id) %>% 
  left_join(DE) %>% 
  select(Id, Comparison, bias, log2FoldChange, padj, everything()) %>% 
  write_tsv("../Results/tables/TransitiveDiffs.txt")
```

## Summary of transitive genes (FDR<0.1 in both comparisons involving treatment)
```{r transitive, echo=FALSE, message=FALSE}
knitr::kable(
group_by(DE, Id, bias) %>% summarise(n=n()) %>% filter(n>1) %>% group_by(bias) %>% summarise(n=n())
)
```

## Representative plots
```{r plots, echo=FALSE, message=FALSE}
filter(DE, Id=='00BCF3E31BBC7ADB91AD7F6DB68F8758') %>% dplyr::slice(1) %>% plotExpression(LibraryInfo, "Uninfected")
filter(DE, Id=='024B835CE3CEE108742B6C1C46C672FE') %>% dplyr::slice(1) %>% plotExpression(LibraryInfo, "WT")
filter(DE, Id=='29410F4989B940B760CACD364C892321') %>% dplyr::slice(1) %>% plotExpression(LibraryInfo, "hog1")

filter(DE, Id=='B8F86937044525FE3BF705C4B6B8C3F8') %>% dplyr::slice(1) %>% plotExpression(LibraryInfo, "hi cooks")

filter(DE, Id=='6ADC146B50087543193CB22FCDAA4F44') %>% dplyr::slice(1) %>% plotExpression(LibraryInfo, "lowest p")
```